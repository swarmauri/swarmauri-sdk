# Peagen Improvement Proposal — **IP-0005**

*Evaluator Pool Deployment Strategies*

---

## 1 Overview

This proposal outlines multiple approaches to running evaluator pools.  A pool
coordinates one or more `EvaluatorBase` classes and feeds them programs to
produce evaluation results.

## 2 Deployment Options

### 2.1 Local Pool

All evaluators run inside the same process using threads or asyncio.  This is
simple for small deployments and local testing.

- Pros: no extra services to manage
- Cons: resources and isolation limited to the host process

### 2.2 Service-Based Pool

The pool is a long‑running service reachable over HTTP or gRPC.  Clients submit
programs and receive results asynchronously.

- Pros: decouples callers from evaluators, can scale horizontally
- Cons: requires network orchestration and monitoring

### 2.3 Pub/Sub Architecture

Programs are published as messages and workers subscribe for jobs.  This enables
flexible scaling across machines.

- Pros: resilient and horizontally scalable
- Cons: depends on external message brokers (Redis, RabbitMQ, etc.)

### 2.4 Docker Container Pool

Each evaluation occurs in a short‑lived Docker container.  Containers guarantee
consistent dependencies and isolate resources.

- Pros: reproducible environment, better isolation than local threads
- Cons: slightly higher overhead and requires a Docker daemon

### 2.5 Kubernetes Cluster

For very large workloads the pool can create Kubernetes jobs or pods for each
program.  Kubernetes supplies sophisticated scheduling and recovery features.

- Pros: powerful orchestration and monitoring
- Cons: highest operational complexity

## 3 Schema Updates

### 3.1 `.peagen.toml.schema`

Introduce a new `[evaluation.pool]` table with the following keys:

| Key            | Type   | Description                                                       |
| -------------- | ------ | ----------------------------------------------------------------- |
| `type`         | string | One of `"local"`, `"service"`, `"pubsub"`, `"docker"`, `"k8s"`. |
| `config`       | table  | Optional, free‑form parameters specific to the selected type.     |

`type` defaults to `"local"` if the table is omitted.  Tools must validate the
value against the allowed set.

### 3.2 `eval_manifest.schema`

Add a new `pool_type` string capturing the resolved deployment type.  This
mirrors `evaluation.pool.type` in `.peagen.toml`.

## 4 Implementation Plan

| Step              | Owner | Files / Components                                |
| ----------------- | ----- | ------------------------------------------------- |
| Extend schemas    | Core  | `peagen.toml.schema.*`, `eval_manifest.schema.*`   |
| Implement pools   | Core  | new modules under `peagen/eval/pools/`            |
| CLI support       | Core  | update `peagen eval` to construct the right pool  |
| Documentation     | Docs  | this IP and user guides                           |

## 5 Backwards Compatibility

Existing workflows using local pools continue to function without modification.
The new table is optional and defaults to a local pool.

---

*Prepared by: Core Team*
*Date: 2025‑05‑24*
