x-as-user: &as_user
  # Run containers as the invoking user (provided by .env)
  user: "${RUN_UID}:${RUN_GID}"
  environment:
    HOME: "/tmp"
    ZDX_FAILURE_MODE: "${ZDX_FAILURE_MODE:-warn}"
  init: true

services:
  trustsig-certs:
    image: alpine:3.21
    container_name: trustsig-certs
    command:
      - /bin/sh
      - -c
      - |
        set -eu
        apk add --no-cache openssl >/dev/null
        mkdir -p /certs

        if [ ! -f /certs/backend-ca.key ] || [ ! -f /certs/backend-ca.crt ]; then
          openssl genrsa -out /certs/backend-ca.key 4096
          openssl req -x509 -new -nodes \
            -key /certs/backend-ca.key \
            -sha256 \
            -days 3650 \
            -subj "/C=US/O=TrustSig/CN=trustsig-backend-ca" \
            -out /certs/backend-ca.crt
        fi

        if [ ! -f /certs/backend.key ] || [ ! -f /certs/backend.crt ]; then
          openssl genrsa -out /certs/backend.key 2048
          openssl req -new \
            -key /certs/backend.key \
            -subj "/C=US/O=TrustSig/CN=backend.local" \
            -out /certs/backend.csr
          printf "subjectAltName=DNS:backend.local,DNS:localhost,IP:127.0.0.1\nextendedKeyUsage=serverAuth\n" > /tmp/backend.ext
          openssl x509 -req \
            -in /certs/backend.csr \
            -CA /certs/backend-ca.crt \
            -CAkey /certs/backend-ca.key \
            -CAcreateserial \
            -out /certs/backend.crt \
            -days 825 \
            -sha256 \
            -extfile /tmp/backend.ext
          rm -f /certs/backend.csr
        fi

        if [ ! -f /certs/client.key ] || [ ! -f /certs/client.crt ]; then
          openssl genrsa -out /certs/client.key 2048
          openssl req -new \
            -key /certs/client.key \
            -subj "/C=US/O=TrustSig/CN=docs-client" \
            -out /certs/client.csr
          printf "extendedKeyUsage=clientAuth\n" > /tmp/client.ext
          openssl x509 -req \
            -in /certs/client.csr \
            -CA /certs/backend-ca.crt \
            -CAkey /certs/backend-ca.key \
            -CAcreateserial \
            -out /certs/client.crt \
            -days 825 \
            -sha256 \
            -extfile /tmp/client.ext
          rm -f /certs/client.csr
        fi

        chmod 600 /certs/*.key
        chmod 644 /certs/*.crt
    volumes:
      - /mnt/data/trustsig/certs:/certs
    restart: "no"

  swarmauri-sdk-docs:
    <<: *as_user
    build:
      context: ../../ # repo root ⬅️
      dockerfile: pkgs/community/zdx/Dockerfile
    container_name: swarmauri-sdk-docs
    volumes:
      - ./swarmauri-sdk:/docs   # Mount the swarmauri-sdk docs directory
      - ../../pkgs:/pkgs           # Mount the repo pkgs directory
      - /mnt/data/trustsig/certs:/certs:ro
    depends_on:
      - trustsig-certs
      - nginx-proxy-manager
    networks:
      - dockernet
    restart: unless-stopped

  peagen-docs:
    <<: *as_user
    build:
      context: ../../ # repo root ⬅️
      dockerfile: pkgs/community/zdx/Dockerfile
    container_name: peagen-docs
    volumes:
      - ./peagen:/docs
      - ../../pkgs:/pkgs
      - /mnt/data/trustsig/certs:/certs:ro
    depends_on:
      - trustsig-certs
      - nginx-proxy-manager
    networks:
      - dockernet
    restart: unless-stopped

  tigrbl-docs:
    <<: *as_user
    build:
      context: ../../ # repo root ⬅️
      dockerfile: pkgs/community/zdx/Dockerfile
    container_name: tigrbl-docs
    volumes:
      - ./tigrbl:/docs
      - ../../pkgs:/pkgs
      - /mnt/data/trustsig/certs:/certs:ro
    depends_on:
      - trustsig-certs
      - nginx-proxy-manager
    networks:
      - dockernet
    restart: unless-stopped

  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    ports:
      - "80:80"   # HTTP
      - "443:443" # HTTPS
      - "81:81"   # Admin UI
    volumes:
      - /mnt/data/npm/data:/data
      - /mnt/data/npm/letsencrypt:/etc/letsencrypt
    environment:
      DISABLE_IPV6: "true"
    networks:
      - dockernet
    restart: unless-stopped

networks:
  dockernet:
    driver: bridge
