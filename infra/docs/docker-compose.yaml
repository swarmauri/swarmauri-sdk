x-as-user: &as_user
  # Run containers as the invoking user (provided by .env)
  user: "${RUN_UID}:${RUN_GID}"
  environment:
    HOME: "/tmp"
  init: true

services:
  swarmauri-sdk-docs:
    <<: *as_user
    build:
      context: ../../ # repo root ⬅️
      dockerfile: pkgs/community/zdx/Dockerfile
    container_name: swarmauri-sdk-docs
    volumes:
      - ./swarmauri-sdk:/docs   # Mount the swarmauri-sdk docs directory
      - ../../pkgs:/pkgs           # Mount the repo pkgs directory
    working_dir: /docs
    command: |
      sh -c "
        set -euo pipefail

        uv pip install --directory /pkgs/community/zdx --system .
        zdx serve --generate --docs-dir /docs --manifest api_manifest.yaml --changed-only
      "
    depends_on:
      - nginx-proxy-manager
    networks:
      - dockernet
    restart: unless-stopped

  peagen-docs:
    <<: *as_user
    build:
      context: ../../ # repo root ⬅️
      dockerfile: pkgs/community/zdx/Dockerfile
    container_name: peagen-docs
    volumes:
      - ./peagen:/docs
      - ../../pkgs:/pkgs
    working_dir: /docs
    command: |
      sh -c "
        set -euo pipefail

        uv pip install --directory /pkgs/community/zdx --system .
        zdx serve --generate --docs-dir /docs --manifest api_manifest.yaml --changed-only
      "
    depends_on:
      - nginx-proxy-manager
    networks:
      - dockernet
    restart: unless-stopped

  tigrbl-docs:
    <<: *as_user
    build:
      context: ../../ # repo root ⬅️
      dockerfile: pkgs/community/zdx/Dockerfile
    container_name: tigrbl-docs
    volumes:
      - ./tigrbl:/docs
      - ../../pkgs:/pkgs
    working_dir: /docs
    command: |
      sh -c "
        set -euo pipefail

        uv pip install --directory /pkgs/community/zdx --system .
        zdx serve --generate --docs-dir /docs --manifest api_manifest.yaml --changed-only
      "
    depends_on:
      - nginx-proxy-manager
    networks:
      - dockernet
    restart: unless-stopped

  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    ports:
      - "80:80"   # HTTP
      - "443:443" # HTTPS
      - "81:81"   # Admin UI
    volumes:
      - /mnt/data/npm/data:/data
      - /mnt/data/npm/letsencrypt:/etc/letsencrypt
    environment:
      DISABLE_IPV6: "true"
    networks:
      - dockernet
    restart: unless-stopped

networks:
  dockernet:
    driver: bridge
