name: 0.7.0 - Mono (Prepare, Validate, Publish)

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Bump type {major,minor,patch,finalize}"
        required: false
        default: "patch"
      set_version:
        description: "Version (e.g. 0.2.0 or 0.2.0.dev1)"
        required: false

concurrency:
  group: dev-branch-prepare-workflow
  cancel-in-progress: false

permissions:
  actions: write
  contents: write       # for pushing commits/tags and creating releases
  deployments: write    # for environment approval gates

jobs:
  dispatch-members:
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Collect workspace members
        id: members
        run: |
          python - <<'PY'
          import json
          import os
          import tomllib

          with open("pkgs/pyproject.toml", "rb") as fh:
              config = tomllib.load(fh)

          members = config.get("tool", {}).get("uv", {}).get("workspace", {}).get("members", [])
          if not isinstance(members, list):
              raise RuntimeError("The 'members' entry is not a list.")

          members = list(dict.fromkeys(members))
          print(f"::notice::Found {len(members)} workspace members.")
          with open(os.environ["GITHUB_OUTPUT"], "a") as gh_out:
              print(f"members={json.dumps(members)}", file=gh_out)
          PY

      - name: Dispatch single-member publish workflows
        env:
          MEMBERS: ${{ steps.members.outputs.members }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref }}
          WORKFLOW_FILE: v0.7.3_single_prepare_validate_publish.yaml
          BUMP_TYPE: ${{ github.event.inputs.bump_type }}
          SET_VERSION: ${{ github.event.inputs.set_version }}
        run: |
          python - <<'PY'
          import json
          import os
          import urllib.request

          members = json.loads(os.environ["MEMBERS"])
          token = os.environ["GH_TOKEN"]
          repo = os.environ["REPO"]
          ref = os.environ["REF"]
          workflow = os.environ["WORKFLOW_FILE"]
          bump_type = os.environ.get("BUMP_TYPE") or ""
          set_version = os.environ.get("SET_VERSION") or ""

          for member in members:
              inputs = {"member": member}
              if bump_type:
                  inputs["bump_type"] = bump_type
              if set_version:
                  inputs["set_version"] = set_version

              payload = json.dumps({"ref": ref, "inputs": inputs}).encode("utf-8")
              request = urllib.request.Request(
                  f"https://api.github.com/repos/{repo}/actions/workflows/{workflow}/dispatches",
                  data=payload,
                  headers={
                      "Authorization": f"Bearer {token}",
                      "Accept": "application/vnd.github+json",
                  },
                  method="POST",
              )
              with urllib.request.urlopen(request) as response:
                  print(
                      f"::notice::Dispatched '{member}' to '{workflow}' "
                      f"(status {response.status})."
                  )
          PY
