name: 0.7.0 - Mono (Prepare, Validate)

on:
  workflow_dispatch:

concurrency:
  group: dev-branch-prepare-workflow
  cancel-in-progress: false

permissions:
  contents: read
  actions: write

jobs:
  dispatch-members:
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies for dispatch
        run: pip install toml

      - name: Dispatch member workflows
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          WORKFLOW_FILE: v0.7.3_single_prepare_validate.yaml
        run: |
          cd pkgs
          python - <<'PY'
          import json
          import os
          import toml
          import urllib.request

          with open("pyproject.toml", "r") as f:
              config = toml.load(f)

          members = config.get("tool", {}).get("uv", {}).get("workspace", {}).get("members", [])
          if not isinstance(members, list):
              raise RuntimeError("The 'members' entry is not a list.")

          members = list(dict.fromkeys(members))

          token = os.environ["GITHUB_TOKEN"]
          repo = os.environ["GITHUB_REPOSITORY"]
          ref_name = os.environ["GITHUB_REF_NAME"]
          workflow_file = os.environ["WORKFLOW_FILE"]

          if not token:
              raise RuntimeError("GITHUB_TOKEN is required to dispatch workflows.")

          for member in members:
              payload = {
                  "ref": ref_name,
                  "inputs": {
                      "member": member,
                  },
              }
              data = json.dumps(payload).encode("utf-8")
              request = urllib.request.Request(
                  f"https://api.github.com/repos/{repo}/actions/workflows/{workflow_file}/dispatches",
                  data=data,
                  method="POST",
                  headers={
                      "Accept": "application/vnd.github+json",
                      "Authorization": f"Bearer {token}",
                      "X-GitHub-Api-Version": "2022-11-28",
                  },
              )
              with urllib.request.urlopen(request) as response:
                  print(f"Dispatched {member}: {response.status}")
          PY
