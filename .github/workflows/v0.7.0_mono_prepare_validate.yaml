name: 0.7.0 - Mono (Prepare, Validate)

on:
  workflow_dispatch:

concurrency:
  group: dev-branch-prepare-workflow
  cancel-in-progress: false

permissions:
  actions: write
  contents: read

jobs:
  dispatch-members:
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Collect workspace members
        id: members
        run: |
          python - <<'PY'
          import json
          import os
          import tomllib

          with open("pkgs/pyproject.toml", "rb") as fh:
              config = tomllib.load(fh)

          members = config.get("tool", {}).get("uv", {}).get("workspace", {}).get("members", [])
          if not isinstance(members, list):
              raise RuntimeError("The 'members' entry is not a list.")

          members = list(dict.fromkeys(members))
          print(f"::notice::Found {len(members)} workspace members.")
          with open(os.environ["GITHUB_OUTPUT"], "a") as gh_out:
              print(f"members={json.dumps(members)}", file=gh_out)
          PY

      - name: Dispatch single-member validation workflows
        env:
          MEMBERS: ${{ steps.members.outputs.members }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref }}
          WORKFLOW_FILE: v0.7.3_single_prepare_validate.yaml
        run: |
          python - <<'PY'
          import json
          import os
          import urllib.request

          members = json.loads(os.environ["MEMBERS"])
          token = os.environ["GH_TOKEN"]
          repo = os.environ["REPO"]
          ref = os.environ["REF"]
          workflow = os.environ["WORKFLOW_FILE"]

          for member in members:
              payload = json.dumps({"ref": ref, "inputs": {"member": member}}).encode("utf-8")
              request = urllib.request.Request(
                  f"https://api.github.com/repos/{repo}/actions/workflows/{workflow}/dispatches",
                  data=payload,
                  headers={
                      "Authorization": f"Bearer {token}",
                      "Accept": "application/vnd.github+json",
                  },
                  method="POST",
              )
              with urllib.request.urlopen(request) as response:
                  print(
                      f"::notice::Dispatched '{member}' to '{workflow}' "
                      f"(status {response.status})."
                  )
          PY
