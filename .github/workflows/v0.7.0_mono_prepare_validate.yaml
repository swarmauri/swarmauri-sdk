name: 0.7.0 - Mono (Prepare, Validate)

on:
  workflow_dispatch:

concurrency:
  group: dev-branch-prepare-workflow
  cancel-in-progress: false

permissions:
  actions: write
  contents: read

jobs:
  dispatch-members:
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Collect workspace members
        id: members
        run: |
          python - <<'PY'
          import json
          import os
          import tomllib

          with open("pkgs/pyproject.toml", "rb") as fh:
              config = tomllib.load(fh)

          members = config.get("tool", {}).get("uv", {}).get("workspace", {}).get("members", [])
          if not isinstance(members, list):
              raise RuntimeError("The 'members' entry is not a list.")

          members = list(dict.fromkeys(members))
          print(f"::notice::Found {len(members)} workspace members.")
          with open(os.environ["GITHUB_OUTPUT"], "a") as gh_out:
              print(f"members={json.dumps(members)}", file=gh_out)
          PY

      - name: Dispatch single-member validation workflows
        env:
          MEMBERS: ${{ steps.members.outputs.members }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref }}
          WORKFLOW_FILE: v0.7.3_single_prepare_validate.yaml
        run: |
          python - <<'PY'
          import json
          import os
          import time
          import urllib.error
          import urllib.request

          members = json.loads(os.environ["MEMBERS"])
          token = os.environ["GH_TOKEN"]
          repo = os.environ["REPO"]
          ref = os.environ["REF"]
          workflow = os.environ["WORKFLOW_FILE"]

          max_attempts = int(os.environ.get("MAX_ATTEMPTS", "5"))
          initial_backoff = float(os.environ.get("INITIAL_BACKOFF_SECONDS", "1.0"))
          max_backoff = float(os.environ.get("MAX_BACKOFF_SECONDS", "16.0"))
          throttle_seconds = float(os.environ.get("THROTTLE_SECONDS", "0.5"))

          failures = []

          def dispatch_member(member_name):
              payload = json.dumps({"ref": ref, "inputs": {"member": member_name}}).encode("utf-8")
              request = urllib.request.Request(
                  f"https://api.github.com/repos/{repo}/actions/workflows/{workflow}/dispatches",
                  data=payload,
                  headers={
                      "Authorization": f"Bearer {token}",
                      "Accept": "application/vnd.github+json",
                  },
                  method="POST",
              )
              with urllib.request.urlopen(request) as response:
                  print(
                      f"::notice::Dispatched '{member_name}' to '{workflow}' "
                      f"(status {response.status})."
                  )

          for member in members:
              attempt = 0
              backoff = initial_backoff
              while True:
                  try:
                      dispatch_member(member)
                      break
                  except urllib.error.HTTPError as exc:
                      attempt += 1
                      if exc.code and 400 <= exc.code < 500 and exc.code != 429:
                          print(
                              f"::error::Failed to dispatch '{member}' to '{workflow}' "
                              f"(status {exc.code})."
                          )
                          failures.append((member, exc.code))
                          break
                      if attempt >= max_attempts:
                          print(
                              f"::error::Failed to dispatch '{member}' to '{workflow}' "
                              f"after {attempt} attempts (status {exc.code})."
                          )
                          failures.append((member, exc.code))
                          break
                      print(
                          f"::warning::Dispatch failed for '{member}' with status {exc.code}; "
                          f"retrying in {backoff:.1f}s (attempt {attempt}/{max_attempts})."
                      )
                      time.sleep(backoff)
                      backoff = min(backoff * 2, max_backoff)
                  except urllib.error.URLError as exc:
                      attempt += 1
                      if attempt >= max_attempts:
                          print(
                              f"::error::Failed to dispatch '{member}' to '{workflow}' "
                              f"after {attempt} attempts ({exc})."
                          )
                          failures.append((member, "url_error"))
                          break
                      print(
                          f"::warning::Dispatch failed for '{member}' ({exc}); "
                          f"retrying in {backoff:.1f}s (attempt {attempt}/{max_attempts})."
                      )
                      time.sleep(backoff)
                      backoff = min(backoff * 2, max_backoff)
              time.sleep(throttle_seconds)

          if failures:
              print("::warning::Some dispatches failed:")
              for member, reason in failures:
                  print(f"::warning::- {member}: {reason}")
          PY
