name: Deploy ZDX Docs

on:
  workflow_dispatch:
    inputs:
      docs_target:
        description: "Docs site to deploy (swarmauri-sdk, tigrbl, peagen, all)"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - swarmauri-sdk
          - tigrbl
          - peagen

concurrency:
  group: zdx-docs-deploy-${{ github.event.inputs.docs_target || 'all' }}
  cancel-in-progress: true

jobs:
  deploy-swarmauri-sdk:
    if: >-
      ${
        github.actor == 'cobycloud' &&
        (github.event.inputs.docs_target == 'swarmauri-sdk' ||
          github.event.inputs.docs_target == 'all')
      }
    runs-on: [docs]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Export runner UID/GID for Compose
        working-directory: infra/docs
        run: |
          printf "RUN_UID=%s\nRUN_GID=%s\n" "$(id -u)" "$(id -g)" > .env
          echo "Using UID:GID $(id -u):$(id -g)"

      - name: Deploy swarmauri-sdk docs
        working-directory: infra/docs
        run: |
          sudo docker system prune -f
          sudo docker compose -f docker-compose.yaml \
            up -d --build --force-recreate --no-deps \
            swarmauri-sdk-docs

  deploy-tigrbl:
    if: >-
      ${
        github.actor == 'cobycloud' &&
        (github.event.inputs.docs_target == 'tigrbl' ||
          github.event.inputs.docs_target == 'all')
      }
    runs-on: [docs]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Export runner UID/GID for Compose
        working-directory: infra/docs
        run: |
          printf "RUN_UID=%s\nRUN_GID=%s\n" "$(id -u)" "$(id -g)" > .env
          echo "Using UID:GID $(id -u):$(id -g)"

      - name: Deploy tigrbl docs
        working-directory: infra/docs
        run: |
          sudo docker system prune -f
          sudo docker compose -f docker-compose.yaml \
            up -d --build --force-recreate --no-deps \
            tigrbl-docs

  deploy-peagen:
    if: >-
      ${
        github.actor == 'cobycloud' &&
        (github.event.inputs.docs_target == 'peagen' ||
          github.event.inputs.docs_target == 'all')
      }
    runs-on: [docs]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Export runner UID/GID for Compose
        working-directory: infra/docs
        run: |
          printf "RUN_UID=%s\nRUN_GID=%s\n" "$(id -u)" "$(id -g)" > .env
          echo "Using UID:GID $(id -u):$(id -g)"

      - name: Deploy peagen docs
        working-directory: infra/docs
        run: |
          sudo docker system prune -f
          sudo docker compose -f docker-compose.yaml \
            up -d --build --force-recreate --no-deps \
            peagen-docs
